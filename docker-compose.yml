version: '3'
services: 
  #######################
  docker-proxy: 
    image: shipyard/docker-proxy:latest
    networks:
    - gestalt
    restart: always
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock:rw
    environment: 
    - PORT=2375
  #######################
  data:
    image: galacticfog/gestalt-data:release-1.2.0
    networks:
    - gestalt
    environment:
    - POSTGRES_USER=gestaltdev
    - POSTGRES_PASSWORD=letmein
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
  #######################
  rabbit:
    image: galacticfog/rabbit:release-1.2.0
    networks:
    - gestalt
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
  #######################
  security:
    image: galacticfog/gestalt-security:release-1.2.0
    networks:
    - gestalt
    depends_on:
    - data
    env_file:
    - db.env
    environment:
    - OAUTH_RATE_LIMITING_AMOUNT=100
    - OAUTH_RATE_LIMITING_PERIOD=1
    - DATABASE_NAME=gestalt-security
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
  #######################
  meta: 
    #image: galacticfog/gestalt-meta:release-1.2.1
    image: gestalt-meta:0.6.22
    networks:
    - gestalt
    depends_on:
    - data
    - security
    env_file:
    - security.env
    - db.env
    - rabbit.env
    environment:
    - DATABASE_NAME=gestalt-meta
    - META_POLICY_CALLBACK_URL=http://meta:9000
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
  #######################
  ui:
    image: galacticfog/gestalt-ui-react:1.0.0-af6686a1
    networks:
    - gestalt
    depends_on:
    - meta
    - security
    ports:
    - "80:80"
    environment:
    - META_API_URL=http://meta:9000
    - SEC_API_URL=http://security:9000
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
  #######################
  bootstrap:
    build: bootstrap
    networks:
    - gestalt
    #image: galacticfog/docker-bootstrap:release-1.2.0
    command: "deploy"
    depends_on:
    - meta
    - security
    env_file:
    - security.env
    - db.env
    - rabbit.env
    deploy:
      restart_policy:
        condition: none
    environment:
    - DOCKER_PROVIDER_HOSTNAME=docker-proxy
    - DOCKER_PROVIDER_PORT=2375
    - DOCKER_PROVIDER_NETWORKS=gestaltdocker_gestalt
    - DATABASE_NAME=postgres
    - SECURITY_PROTOCOL=http
    - SECURITY_HOSTNAME=security
    - SECURITY_PORT=9000
    - SECURITY_ADMIN_USERNAME=root
    - SECURITY_ADMIN_PASSWORD=root
    - SECURITY_URL=http://security:9000
    - META_URL=http://meta:9000
    - META_HOSTNAME=meta
    - META_PORT=9000
    - META_PROTOCOL=http
    - LASER_DB_NAME=gestalt-laser
    - LASER_CPU=1.0
    - LASER_MEMORY=1536
    - RABBIT_HOSTNAME=rabbit
    - RABBIT_PORT=5672
    - KONG_DB_NAME=gestalt-kong
    - GATEWAY_DB_NAME=gestalt-api-gateway
    - CONTAINER_IMAGE_RELEASE_TAG=release-1.2.0
    - NETWORK=gestaltdocker_gestalt
    - LASER_IMG=galacticfog/gestalt-laser:1.9.6-debug-7f9c8aea
    - KONG_IMG=galacticfog/kong:release-1.2.1
    - API_GATEWAY_IMG=galacticfog/gestalt-api-gateway:release-1.2.1
    #- LASER_JS_IMG=override
    #- LASER_JVM_IMG=override
    #- LASER_DOTNET_IMG=override
    #- LASER_PYTHON_IMG=override
    #- LASER_RUBY_IMG=override
    #- LASER_GOLANG_IMG=override
    #- POLICY_IMG=override
networks: 
  gestalt: 
    driver: overlay
